<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Infrastructure Vault</title>
    <script src="https://cdn.jsdelivr.net/npm/hash-wasm@4/dist/argon2.umd.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a; --bg-light: #f8fafc; --accent: #3b82f6;
            --border: #e2e8f0; --text-main: #1e293b; --text-muted: #64748b;
            --danger: #ef4444; --success: #10b981; --purple: #8b5cf6; --warning: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { display: flex; min-height: 100vh; background-color: var(--bg-light); color: var(--text-main); }

        #sync-banner { display: none; position: fixed; top: 0; width: 100%; background: #fff7ed; border-bottom: 1px solid #fed7aa; padding: 12px; text-align: center; font-size: 0.85rem; color: #9a3412; font-weight: 600; z-index: 1000; }
        .sidebar { flex: 0 0 320px; background-color: var(--bg-dark); color: white; padding: 40px; display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh; }
        .sidebar h1 { font-size: 2.5rem; margin-bottom: 20px; line-height: 1; }
        .sidebar-meta { margin-top: auto; padding-top: 20px; border-top: 1px solid #334155; font-size: 0.8rem; color: #94a3b8; }
        .content-area { flex: 1; display: flex; justify-content: center; padding: 80px 20px; overflow-y: auto; }
        .card { width: 100%; max-width: 700px; background: white; padding: 35px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.03); }

        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 25px; gap: 20px; }
        .tab { padding: 10px 0; cursor: pointer; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid transparent; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .search-box { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 8px; outline: none; }

        .entry-form { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; color: var(--text-main); }
        input, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; outline: none; }
        
        .strength-container { height: 4px; background: #e2e8f0; border-radius: 2px; margin: 8px 0; overflow: hidden; }
        .strength-bar { height: 100%; width: 0%; transition: 0.4s; }

        .entry-item { padding: 15px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px; background: white; }
        .secret-area { margin-top: 12px; padding: 12px; background: #fff7ed; border: 1px solid #fed7aa; border-radius: 6px; font-family: monospace; font-size: 0.85rem; word-break: break-all; color: #c2410c; display: none; }
        .secret-area.active { display: block; }

        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; color: white; }
        .btn:disabled { opacity: 0.6; cursor: wait; }
        .btn-accent { background: var(--accent); }
        .btn-purple { background: var(--purple); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success) !important; }
        .tag-badge { background: #e0f2fe; color: #0369a1; font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 4px; margin-left: 8px; }
        .upload-zone { border: 2px dashed var(--border); padding: 15px; text-align: center; border-radius: 10px; cursor: pointer; color: var(--text-muted); margin-bottom: 15px; font-size: 0.85rem; }
    </style>
</head>
<body>

<div id="sync-banner">⚠️ New changes made. Download a fresh backup to keep your data safe.</div>

<section class="sidebar">
    <h1>Vault</h1>
    <p style="color: #94a3b8; font-size: 0.9rem;">Hardened Infrastructure Manager</p>
    <div class="sidebar-meta" id="sidebar-meta" style="display:none">
        <p><b>Last Session Activity:</b></p>
        <p id="last-update">No changes yet</p>
        <p id="entry-count" style="margin-top: 5px;">0 entries stored</p>
    </div>
</section>

<main class="content-area">
    <div id="auth-view" class="card">
        <div class="tabs" id="auth-tabs">
            <div class="tab active" onclick="switchAuth('new')">New Vault</div>
            <div class="tab" onclick="switchAuth('restore')">Restore Backup</div>
        </div>

        <div id="auth-new">
            <div class="input-group">
                <label>Master Key</label>
                <input type="password" id="new-key" oninput="checkStrength('new-key', 'strength-bar-init', 'strength-text-init')" placeholder="Strong passphrase">
                <div class="strength-container"><div id="strength-bar-init" class="strength-bar"></div></div>
                <p id="strength-text-init" style="font-size: 0.7rem; color: var(--text-muted);">Strength: None</p>
            </div>
            <div class="input-group">
                <label>Confirm Master Key</label>
                <input type="password" id="new-confirm" placeholder="Repeat passphrase">
            </div>
            <button id="create-btn" class="btn btn-accent" style="width:100%" onclick="initNewVault()">Initialize Vault</button>
        </div>

        <div id="auth-restore" style="display:none">
            <div class="upload-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                <span id="file-label">Select vault_backup.json</span>
                <input type="file" id="file-input" style="display:none" onchange="stageFile(this)">
            </div>
            <div class="input-group">
                <label>Master Key</label>
                <input type="password" id="restore-key" placeholder="Enter passphrase">
            </div>
            <button id="restore-btn" class="btn btn-purple" style="width:100%" onclick="initRestoreVault()">Decrypt & Restore</button>
        </div>
    </div>

    <div id="vault-view" class="card" style="display:none">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('passwords')">Passwords</div>
            <div class="tab" onclick="switchTab('keys')">Keys</div>
            <div class="tab" onclick="switchTab('certs')">Certs</div>
            <div class="tab" onclick="switchTab('security')" style="color: var(--danger)">Security</div>
        </div>

        <div id="vault-content-section">
            <input type="text" id="v-search" class="search-box" placeholder="Filter assets..." oninput="renderList()">

            <div class="entry-form">
                <div id="file-content-section" style="display:none">
                    <div class="upload-zone" onclick="document.getElementById('content-uploader').click()">
                        Click to import file content
                        <input type="file" id="content-uploader" style="display:none" onchange="importContent(this)">
                    </div>
                </div>

                <div class="form-header" style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                    <label style="margin:0">Add Infrastructure Asset</label>
                    <button id="gen-btn" class="btn btn-purple" style="padding:4px 10px; font-size:0.75rem" onclick="generate()">Generate Password</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <input type="text" id="n-name" placeholder="Name">
                    <input type="text" id="n-tag" placeholder="Tag">
                </div>
                <div id="login-field" style="margin-top:10px">
                    <input type="text" id="n-login" placeholder="Username/Login">
                </div>
                <textarea id="n-content" style="margin-top:10px; height:80px" placeholder="Secret content..."></textarea>
                <button id="add-btn" class="btn btn-accent" style="width:100%; margin-top:10px" onclick="addEntry()">Add & Auto-Encrypt</button>
            </div>

            <div id="list-container"></div>
        </div>

        <div id="security-section" style="display:none">
            <h3 style="margin-bottom: 15px;">Change Master Password</h3>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">
                Changing your password will re-encrypt all stored assets with a new key. 
                <b>Download a new backup immediately after this process.</b>
            </p>
            <div class="input-group">
                <label>New Master Password</label>
                <input type="password" id="change-pass-new" oninput="checkStrength('change-pass-new', 'strength-bar-change', 'strength-text-change')" placeholder="New passphrase">
                <div class="strength-container"><div id="strength-bar-change" class="strength-bar"></div></div>
                <p id="strength-text-change" style="font-size: 0.7rem; color: var(--text-muted);">Strength: None</p>
            </div>
            <div class="input-group">
                <label>Confirm New Password</label>
                <input type="password" id="change-pass-confirm" placeholder="Repeat new passphrase">
            </div>
            <button id="change-pass-btn" class="btn btn-danger" style="width:100%" onclick="handleChangePassword()">Update & Re-encrypt Vault</button>
        </div>
        
        <div style="margin-top:30px; border-top:1px solid var(--border); padding-top:20px; display:flex; gap:10px">
            <button class="btn" style="flex:1; background:#f1f5f9; color:#475569" onclick="downloadBackup()">Download Backup JSON</button>
            <button class="btn btn-danger" onclick="lock()">Lock Vault</button>
        </div>
    </div>
</main>

<script>
    let vaultData = { passwords: [], keys: [], certs: [] };
    let currentKey = null;
    let activeTab = 'passwords';
    let stagedBlob = null;
    let hasNewChanges = false;

    // --- CRYPTO ---
    async function deriveKey(pass, salt) {
        const hash = await hashwasm.argon2id({
            password: pass, salt: salt, iterations: 3, parallelism: 4, memorySize: 65536, hashLength: 32, outputType: 'binary'
        });
        return crypto.subtle.importKey("raw", hash, { name: "AES-GCM" }, false, ["encrypt", "decrypt"]);
    }

    async function autoSave() {
        const s = crypto.getRandomValues(new Uint8Array(16));
        const i = crypto.getRandomValues(new Uint8Array(12));
        const key = await deriveKey(currentKey, s);
        const enc = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: i }, key, new TextEncoder().encode(JSON.stringify(vaultData)));
        
        localStorage.setItem('v_blob', JSON.stringify({
            ct: btoa(String.fromCharCode(...new Uint8Array(enc))),
            s: btoa(String.fromCharCode(...s)),
            i: btoa(String.fromCharCode(...i))
        }));
        
        hasNewChanges = true;
        document.getElementById('sync-banner').style.display = 'block';
        updateSidebar();
    }

    // --- AUTH ---
    function switchAuth(m) {
        document.getElementById('auth-new').style.display = m === 'new' ? 'block' : 'none';
        document.getElementById('auth-restore').style.display = m === 'restore' ? 'block' : 'none';
        document.querySelectorAll('#auth-tabs .tab').forEach((t, i) => t.classList.toggle('active', (m==='new' && i===0) || (m==='restore' && i===1)));
    }

    function checkStrength(inputId, barId, textId) {
        const p = document.getElementById(inputId).value;
        const b = document.getElementById(barId);
        const t = document.getElementById(textId);
        let s = 0;
        if(p.length > 8) s++; if(/[A-Z]/.test(p)) s++; if(/[0-9]/.test(p)) s++; if(/[^A-Za-z0-9]/.test(p)) s++;
        const c = ['#ef4444', '#f59e0b', '#3b82f6', '#10b981'];
        const l = ['Weak', 'Fair', 'Good', 'Strong'];
        b.style.width = p.length ? (s+1)*25 + '%' : '0%'; b.style.background = c[s] || c[0];
        t.innerText = p.length ? 'Strength: ' + l[s] : 'Strength: None';
    }

    async function initNewVault() {
        const p1 = document.getElementById('new-key').value;
        const p2 = document.getElementById('new-confirm').value;
        if(p1 !== p2 || p1.length < 8) return alert("Mismatch or too short.");
        currentKey = p1; await autoSave(); openVault();
        hasNewChanges = false; document.getElementById('sync-banner').style.display = 'none';
    }

    function stageFile(input) {
        const reader = new FileReader();
        reader.onload = (e) => { stagedBlob = JSON.parse(e.target.result); document.getElementById('file-label').innerText = "File Staged."; };
        reader.readAsText(input.files[0]);
    }

    async function initRestoreVault() {
        const p = document.getElementById('restore-key').value;
        if(!stagedBlob || !p) return;
        try {
            const s = Uint8Array.from(atob(stagedBlob.s), c => c.charCodeAt(0));
            const i = Uint8Array.from(atob(stagedBlob.i), c => c.charCodeAt(0));
            const ct = Uint8Array.from(atob(stagedBlob.ct), c => c.charCodeAt(0));
            const key = await deriveKey(p, s);
            const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: i }, key, ct);
            vaultData = JSON.parse(new TextDecoder().decode(dec));
            currentKey = p; localStorage.setItem('v_blob', JSON.stringify(stagedBlob)); openVault();
        } catch (e) { alert("Fail."); }
    }

    // --- VAULT & TABS ---
    function openVault() {
        document.getElementById('auth-view').style.display = 'none';
        document.getElementById('vault-view').style.display = 'block';
        document.getElementById('sidebar-meta').style.display = 'block';
        renderList(); updateSidebar();
    }

    function switchTab(t) {
        activeTab = t;
        document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.innerText.toLowerCase() === t.toLowerCase()));
        
        const contentSection = document.getElementById('vault-content-section');
        const securitySection = document.getElementById('security-section');

        if(t === 'security') {
            contentSection.style.display = 'none';
            securitySection.style.display = 'block';
        } else {
            contentSection.style.display = 'block';
            securitySection.style.display = 'none';
            document.getElementById('login-field').style.display = t === 'passwords' ? 'block' : 'none';
            document.getElementById('gen-btn').style.display = t === 'passwords' ? 'block' : 'none';
            document.getElementById('file-content-section').style.display = t === 'passwords' ? 'none' : 'block';
            renderList();
        }
    }

    // --- PASSWORD CHANGE LOGIC ---
    async function handleChangePassword() {
        const n1 = document.getElementById('change-pass-new').value;
        const n2 = document.getElementById('change-pass-confirm').value;
        const btn = document.getElementById('change-pass-btn');

        if(n1 !== n2 || n1.length < 8) return alert("Passwords mismatch or too weak.");
        
        btn.disabled = true;
        btn.innerText = "Re-encrypting Vault (Argon2id)...";

        // Logic: Update the currentKey and run autoSave
        // Since vaultData is already decrypted in memory, we just encrypt with new key
        currentKey = n1;
        await autoSave();

        alert("Master password updated successfully. Your vault is now re-encrypted.");
        btn.disabled = false;
        btn.innerText = "Update & Re-encrypt Vault";
        
        // Clear fields
        document.getElementById('change-pass-new').value = "";
        document.getElementById('change-pass-confirm').value = "";
        checkStrength('change-pass-new', 'strength-bar-change', 'strength-text-change');
    }

    function importContent(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('n-content').value = e.target.result;
            if(!document.getElementById('n-name').value) document.getElementById('n-name').value = input.files[0].name;
        };
        reader.readAsText(input.files[0]);
    }

    function renderList() {
        const container = document.getElementById('list-container');
        const query = document.getElementById('v-search').value.toLowerCase();
        container.innerHTML = '';
        if(!vaultData[activeTab]) return;

        vaultData[activeTab].filter(e => e.name.toLowerCase().includes(query) || (e.tag && e.tag.toLowerCase().includes(query)))
        .forEach(e => {
            const div = document.createElement('div'); div.className = 'entry-item';
            div.innerHTML = `<div style="display:flex; justify-content:space-between">
                <div><h4>${e.name}<span class="tag-badge">${e.tag || ''}</span></h4>
                <p style="font-size:0.75rem; color:var(--text-muted)">${e.mod}</p></div>
                <div><button class="btn btn-accent" style="padding:4px 8px" onclick="reveal(${e.id})">View</button>
                <button class="btn btn-danger" style="padding:4px 8px" onclick="remove(${e.id})">×</button></div>
            </div><div id="sec-${e.id}" class="secret-area"></div>`;
            container.appendChild(div);
        });
    }

    async function addEntry() {
        const name = document.getElementById('n-name').value, content = document.getElementById('n-content').value;
        if(!name || !content) return;
        vaultData[activeTab].push({ id: Date.now(), name, content, tag: document.getElementById('n-tag').value, mod: new Date().toLocaleTimeString() });
        ['n-name','n-tag','n-login','n-content'].forEach(id => document.getElementById(id).value = '');
        await autoSave(); renderList();
    }

    async function remove(id) { vaultData[activeTab] = vaultData[activeTab].filter(x => x.id !== id); await autoSave(); renderList(); }

    function reveal(id) {
        const el = document.getElementById(`sec-${id}`);
        if(el.classList.contains('active')) el.classList.remove('active');
        else { el.innerText = vaultData[activeTab].find(x => x.id === id).content; el.classList.add('active'); }
    }

    function updateSidebar() {
        document.getElementById('last-update').innerText = "Encrypted: " + new Date().toLocaleTimeString();
        document.getElementById('entry-count').innerText = (vaultData.passwords.length + vaultData.keys.length + vaultData.certs.length) + " Assets";
    }

    function downloadBackup() {
        const blob = localStorage.getItem('v_blob');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([blob], {type: 'application/json'}));
        a.download = 'vault_backup.json'; a.click();
        hasNewChanges = false;
        document.getElementById('sync-banner').style.display = 'none';
    }

    function lock() { window.location.reload(); }
    function generate() { document.getElementById('n-content').value = Array.from(crypto.getRandomValues(new Uint32Array(16))).map(x => "abcdefghjkmnpqrstuvwxyzABCDEFGHJKMNPQRSTUVWXYZ23456789!@#$%^&*".charAt(x % 62)).join(''); }
</script>
</body>
</html>